<!DOCTYPE html>
<html lang="es">
<style>
    /* ç§»åŠ¨ç«¯é€‚é… */
    body {
        max-width: 100% !important;
        margin: 10px auto !important;
        padding: 10px !important;
    }

    #logo {
        height: 30px !important;
        top: 5px !important;
        left: 5px !important;
    }

    #startScreen img {
        max-width: 90% !important;
        margin: 10px auto !important;
    }

    #startScreen button {
        font-size: 18px !important;
        padding: 10px 20px !important;
    }

    #levelStatus {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        font-size: 16px !important;
        margin: 10px 0;
    }

    .hearts {
        font-size: 24px !important;
        margin: 10px !important;
    }

    #toneButtons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        padding: 0 10px;
    }

    .tone-btn {
        width: 60px !important;
        height: 60px !important;
        font-size: 24px !important;
    }

    #progress {
        margin: 10px !important;
        height: 6px !important;
    }

    #resultModal {
        width: 90% !important;
        padding: 15px !important;
    }

    #trophyImage {
        width: 90% !important;
        height: auto !important;
    }

    h1 {
        font-size: 24px !important;
        padding: 0 10px;
    }

    h2 {
        font-size: 20px !important;
    }

    #controls button {
        margin: 10px !important;
        padding: 8px 16px !important;
    }

    #resultActions button {
        display: block;
        width: 100%;
        margin: 8px 0 !important;
    }

    .feedback-image {
        max-width: 150px !important;
    }

    @media (min-width: 768px) {
        /* ä¿æŒåŸæœ‰PCæ ·å¼ */
        body {
            max-width: 800px !important;
            margin: 20px auto !important;
            padding: 20px !important;
        }
        /* å…¶ä»–PCç«¯æ ·å¼æ¢å¤... */
    }
</style>
</head>
<body>
    <img src="logo.png" id="logo" alt="Logo">

    <div id="startScreen">
        <h1>Â¡Descubre tu talento para el chino! ğŸ¯</h1>
        <img src="start.png" alt="Comienza el juego">
        <button onclick="startGame()" style="font-size: 24px; padding: 15px 30px;">
            ğŸš€ EMPEZAR
        </button>
    </div>

    <div id="gameContainer">
        <h2 id="levelStatus"></h2>
        <div class="hearts" id="hearts">
            <span class="heart">â¤</span>
            <span class="heart">â¤</span>
            <span class="heart">â¤</span>
        </div>
        <div id="progress"><div id="progressBar"></div></div>
        
        <div id="toneButtons">
            <button class="tone-btn" data-tone="1">â€”</button>
            <button class="tone-btn" data-tone="2">/</button>
            <button class="tone-btn" data-tone="3">V</button>
            <button class="tone-btn" data-tone="4">\</button>
        </div>

        <div id="controls">
            <button onclick="playQuestionPhase()" style="margin: 20px; padding: 10px 20px;">
                ğŸ”„ REPETIR
            </button>
        </div>
    </div>

<div id="resultModal">
    <h2 id="resultTitle"></h2>
    <img id="trophyImage" src="trophy.png" alt="Trofeo" style="display: none; width: 400px; height: 300px; margin: 15px auto;">
    <p id="resultMessage"></p>
    <div id="resultActions">
        <button onclick="restartGame()">ğŸ”„ REINTENTAR</button>
        <button onclick="shareResult()">ğŸ“¤ COMPARTIR</button>
        <button onclick="location.href='https://nas.io/baimu'">ğŸ“ QUIERO CLASE ğŸ¤©</button>
    </div>
</div>

    <!-- Audio Elements -->
    <audio id="winSound" src="win.mp3"></audio>
    <audio id="failSound" src="fail.mp3"></audio>
    <audio id="trophySound" src="trophy.mp3"></audio>

    <script>
        const tones = [
            { tone: 1, example: "a" },
            { tone: 2, example: "b" },
            { tone: 3, example: "c" },
            { tone: 4, example: "d" }
        ];

        let currentLevel = 1;
        let currentSequence = [];
        let userInput = [];
        let mistakes = 0;
        const maxMistakes = 3;
        const synth = window.speechSynthesis;
        let currentStep = 0;
        let audioController = new AbortController();
        let isProcessing = false; // æ–°å¢ç‚¹å‡»é”

        async function playSingleTone(index, signal) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(currentSequence[index].example);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                
                const btn = document.querySelector(`[data-tone="${currentSequence[index].tone}"]`);
                btn.classList.add('playing');
                
                utterance.onend = () => {
                    btn.classList.remove('playing');
                    resolve();
                };
                
                synth.speak(utterance);
                signal.addEventListener('abort', () => {
                    synth.cancel();
                    btn.classList.remove('playing');
                    resolve();
                });
            });
        }

        async function playQuestionPhase() {
            disableButtons(true);
            isProcessing = true; // é”å®šæ“ä½œ
            audioController.abort();
            audioController = new AbortController();
            
            try {
                for (let i = 0; i < currentSequence.length; i++) {
                    await playSingleTone(i, audioController.signal);
                    await new Promise(r => setTimeout(r, 300));
                }
            } finally {
                currentStep = 0;
                disableButtons(false);
                isProcessing = false; // è§£é”æ“ä½œ
            }
        }

        async function checkInput(selectedTone) {
            if (isProcessing) return; // é˜»æ­¢é‡å¤ç‚¹å‡»
            
            const expectedTone = currentSequence[currentStep].tone;
            
            if (selectedTone == expectedTone) {
                isProcessing = true; // é”å®šæ“ä½œ
                audioController.abort();
                audioController = new AbortController();
                
                // å…ˆæ›´æ–°æ­¥éª¤å†æ’­æ”¾éŸ³é¢‘
                currentStep++;
                const currentIndex = currentStep - 1;
                
                try {
                    await playSingleTone(currentIndex, audioController.signal);
                    
                    if (currentStep === currentSequence.length) {
                        showFeedback('pass.png', 'winSound');
                        if (currentLevel === 10) {
                            setTimeout(() => showResult(10), 1000);
                        } else {
                            setTimeout(nextLevel, 1000);
                        }
                    }
                } finally {
                    isProcessing = false; // è§£é”æ“ä½œ
                }
            } else {
                isProcessing = true; // é”å®šæ“ä½œ
                audioController.abort();
                showFeedback('sad.png', 'failSound');
                const btn = document.querySelector(`[data-tone="${selectedTone}"]`);
                btn.classList.add('wrong');
                setTimeout(() => btn.classList.remove('wrong'), 300);
                
                mistakes++;
                updateHearts();
                
                if (mistakes >= maxMistakes) {
                    setTimeout(() => showResult(currentLevel - 1), 1000);
                } else {
                    disableButtons(true);
                    setTimeout(async () => {
                        await playQuestionPhase();
                        disableButtons(false);
                    }, 1000);
                }
                isProcessing = false; // è§£é”æ“ä½œ
            }
        }

        // å…¶ä»–ä¿æŒä¸å˜çš„å‡½æ•°
        function updateHearts() {
            const hearts = Array.from(document.querySelectorAll('.heart')).reverse();
            hearts.forEach((heart, index) => {
                heart.classList.toggle('lost', index < mistakes);
            });
        }

        function showFeedback(imageSrc, soundId) {
            const feedback = document.createElement('img');
            feedback.src = imageSrc;
            feedback.className = 'feedback-image';
            document.body.appendChild(feedback);
            
            const sound = document.getElementById(soundId);
            sound.currentTime = 0;
            sound.play();

            setTimeout(() => {
                feedback.remove();
            }, 2000);
        }

        function generateSequence(length) {
            return Array.from({length}, () => tones[Math.floor(Math.random()*4)]);
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            mistakes = 0;
            updateHearts();
            nextLevel();
        }

        function nextLevel() {
            currentSequence = generateSequence(currentLevel);
            document.getElementById('levelStatus').textContent = `Nivel ${currentLevel} - ${currentLevel} sÃ­laba${currentLevel > 1 ? 's' : ''}`;
            document.getElementById('progressBar').style.width = `${(currentLevel/10)*100}%`;
            playQuestionPhase();
            currentLevel++;
        }

        function disableButtons(state) {
            document.querySelectorAll('.tone-btn').forEach(btn => {
                btn.disabled = state;
                btn.onclick = state ? null : () => checkInput(btn.dataset.tone);
            });
        }

        function restartGame() {
            document.getElementById('resultModal').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameContainer').style.display = 'none';
            currentLevel = 1;
            mistakes = 0;
            updateHearts();
        }

        function shareResult() {
            alert("Â¡FunciÃ³n de compartir en desarrollo! ğŸš§");
        }

        function showResult(passedLevels) {
            const messages = [
                { level: 10, msg: "Â¡Dios mÃ­o, eres un prodigio del chino! ğŸŒ Tu talento supera al 99% del mundo. Â¡No desperdicies este don, empieza ya nuestro curso GRATIS!" },
                { level: 9, msg: "Â¡Casi perfecto! ğŸŒŸ Tu talento supera al 95% del mundo. Â¿Listo para ser fluido? Â¡Nuestro curso te llevarÃ¡ al mÃ¡ximo!" },
                { level: 8, msg: "Â¡Impresionante! ğŸ”¥ Superas al 80%. Solo un paso mÃ¡s para la maestrÃ­a. Â¡Aprovecha nuestras lecciones gratuitas!" },
                { level: 7, msg: "Â¡Muy bien! ğŸš€ Tu chino supera al 65%. Con un poco de estudio, Â¡serÃ¡s increÃ­ble! Â¿Empezamos hoy?" },
                { level: 6, msg: "Â¡Buen progreso! ğŸŒ± Superas al 50%. Â¿Quieres destacar? Â¡Nuestro curso te da las herramientas!" },
                { level: 5, msg: "Â¡Tienes potencial! ğŸ’¡ Superas al 40%. Con nuestras clases, Â¡transformarÃ¡s 'hola' en conversaciones!" },
                { level: 4, msg: "Â¡Sigue asÃ­! ğŸŒˆ Tu chino supera al 30%. Â¿SabÃ­as que en 10 lecciones podrÃ­as triplicarlo? Â¡Prueba gratis!" },
                { level: 2, msg: "Â¿Primer contacto? ğŸ˜… Superas al 20%. Â¡Aprende pinyin con nosotros y verÃ¡s la magia! âœ¨" },
                { level: 0, msg: "Â¿Se te resbalÃ³ el dedo? ğŸ˜œ Â¡IntÃ©ntalo de nuevo o mejorâ€¦ ven a descubrir el chino desde cero! ğŸ†“" }
            ];

            const result = messages.find(m => passedLevels >= m.level) || messages[messages.length-1];
            
    // æ’­æ”¾å¥–æ¯éŸ³æ•ˆ
    const trophySound = document.getElementById('trophySound');
    trophySound.currentTime = 0;
    trophySound.play();

    // æ§åˆ¶å›¾ç‰‡æ˜¾ç¤º
    const trophyImg = document.getElementById('trophyImage');
    if(passedLevels >= 1) {
        trophyImg.style.display = 'block';
    } else {
        trophyImg.style.display = 'none';
    }

    document.getElementById('resultTitle').textContent = `Â¡Completaste ${passedLevels} niveles!`;
    document.getElementById('resultMessage').textContent = result.msg;
    document.getElementById('resultModal').style.display = 'block';
    document.getElementById('gameContainer').style.display = 'none';
}
</script>

</body>
</html>
