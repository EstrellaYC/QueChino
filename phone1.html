<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <style>
        body {
            touch-action: manipulation; /* ç¦ç”¨åŒå‡»ç¼©æ”¾ */
            -ms-touch-action: manipulation; /* IEå…¼å®¹ */
        }
        {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* æ–°å¢æ ·å¼ */
        #startScreen h1 {
            font-size: 60px;
            color: #503733;
        }
        #startScreen h2 {
            font-size: 42px;
            color: #834b41;
            margin: 20px 0;
        }
        .tone-btn {
            height: 200px !important;
            font-size: 80px !important;
            line-height: 200px !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }
        #toneButtons {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        #controls button {
            font-size: 40px !important;
        }
        #resultTitle {
            font-size: 40px !important;
        }
        #resultMessage {
            font-size: 40px !important;
        }
        #resultActions {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #resultActions button {
            font-size: 40px !important;
        }


        /* ä¿æŒä¹‹å‰æ‰€æœ‰æ ·å¼ä¸å˜ */
        body {
            font-family: -apple-system, Roboto;
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            background: #FFF5E6;
            text-align: center;
            position: relative;
        }

        #logo {
            height: 200px;
        }

        #startScreen img {
            display: block;
            margin: 20px auto;
            max-width: 800px;
        }

        #gameContainer {
            display: none;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        button {
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
            color: white !important;
            padding: 30px 150px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }

        /* å¼€å§‹æŒ‰é’® & é‡æ–°å¼€å§‹æŒ‰é’® */
        #startScreen button,
        #resultActions button:nth-child(1) {
            background: #EEB0A1 !important;
        }

        /* é‡æ’­éŸ³é¢‘æŒ‰é’® */
        #controls button {
            background: #EBCD8E !important;
        }

        /* åˆ†äº«æŒ‰é’® */
        #resultActions button:nth-child(2) {
            background: #72D2E2 !important;
        }

        /* å»ä¸Šè¯¾æŒ‰é’® */
        #resultActions button:nth-child(3) {
            background: #96D979 !important;
        }

        /* ç‚¹å‡»æ•ˆæœ */
        button:active {
            transform: translateY(1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }

        /* ä¿ç•™åŸæœ‰æ‹¼éŸ³æŒ‰é’®æ ·å¼ */
        .tone-btn {
            background: white !important;
            color: #4A90E2 !important;
            border: 6px solid #4A90E2 !important;
            box-shadow: none !important;
        }

        .tone-btn.playing {
            background: #4A90E2 !important;
            color: white !important;
        }

        .tone-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .hearts {
            margin: 40px;
            font-size: 64px;
            display: flex;
            justify-content: center;
            flex-direction: row-reverse;
        }

        .heart {
            color: #FF4757;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .heart.lost {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        #levelStatus {
            font-size: 60px;
            color: #4A90E2;
        }

        .feedback-image {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-height: 600px;
            z-index: 100;
            animation: fadeInOut 1s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        #progress {
            height: 20px;
            background: #eee;
            margin: 40px;
            border-radius: 10px;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: #4A90E2;
            transition: width 0.5s;
        }

        #resultModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 60px;
            box-shadow: 0 0 40px rgba(0,0,0,0.2);
            border-radius: 30px;
            z-index: 200;
        }
      /* åˆ†äº«æç¤ºæ ·å¼ */
        #shareFallback {
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 15px 30px;
          border-radius: 25px;
          display: none;
          animation: floatUp 1.5s;
        }

        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            100% { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body>
    
    <img src="logo.png" id="logo" alt="Logo">

    <div id="startScreen">
        <h1>ğŸ¯Reto de PinyinğŸ¯ </h1>
        <h2>Â¡Descubre tu talento para hablar chino!</h2>
        <img src="start.png" alt="Comienza el juego">
        <button onclick="startGame()" style="font-size: 40px; padding: 10px 20px;">
            ğŸ¥¡ EMPEZAR ğŸ¥¢
        </button>
    </div>

    <div id="gameContainer">
        <h2 id="levelStatus"></h2>
        <div class="hearts" id="hearts">
            <span class="heart">â¤</span>
            <span class="heart">â¤</span>
            <span class="heart">â¤</span>
        </div>
        <div id="progress"><div id="progressBar"></div></div>
        
        <div id="toneButtons">
            <button class="tone-btn" data-tone="1">â€”</button>
            <button class="tone-btn" data-tone="2">â•±</button>
            <button class="tone-btn" data-tone="3">âˆ¨</button>
            <button class="tone-btn" data-tone="4">â•²</button>
        </div>

        <div id="controls">
            <button onclick="playQuestionPhase()" style="margin: 40px; padding: 10px 20px;">
                ğŸ” REPETIR
            </button>
        </div>
    </div>

<div id="resultModal">
    <h2 id="resultTitle"></h2>
    <img id="trophyImage" src="trophy.png" alt="Trofeo" style="display: none; width: 800px; height: 600px; margin: 15px auto;">
    <p id="resultMessage"></p>
    <div id="resultActions">
        <button onclick="restartGame()">REINTENTAR â–¶</button>
        <button onclick="shareResult()">COMPARTIR â†©</button>
        <button onclick="location.href='https://nas.io/baimu'">ğŸ“ QUIERO CLASE ğŸ¤©</button>
    </div>
</div>

    <!-- Audio Elements -->
    <audio id="winSound" src="win.mp3"></audio>
    <audio id="failSound" src="fail.mp3"></audio>
    <audio id="trophySound" src="trophy.mp3"></audio>

    <script>
        const tones = [
            { tone: 1, example: "a" },
            { tone: 2, example: "b" },
            { tone: 3, example: "c" },
            { tone: 4, example: "d" }
        ];

        let currentLevel = 1;
        let currentSequence = [];
        let userInput = [];
        let mistakes = 0;
        const maxMistakes = 3;
        const synth = window.speechSynthesis;
        let currentStep = 0;
        let audioController = new AbortController();
        let isProcessing = false; // æ–°å¢ç‚¹å‡»é”

        async function playSingleTone(index, signal) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(currentSequence[index].example);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                
                const btn = document.querySelector(`[data-tone="${currentSequence[index].tone}"]`);
                btn.classList.add('playing');
                
                utterance.onend = () => {
                    btn.classList.remove('playing');
                    resolve();
                };
                
                synth.speak(utterance);
                signal.addEventListener('abort', () => {
                    synth.cancel();
                    btn.classList.remove('playing');
                    resolve();
                });
            });
        }

        async function playQuestionPhase() {
            disableButtons(true);
            isProcessing = true; // é”å®šæ“ä½œ
            audioController.abort();
            audioController = new AbortController();
            
            try {
                for (let i = 0; i < currentSequence.length; i++) {
                    await playSingleTone(i, audioController.signal);
                    await new Promise(r => setTimeout(r, 300));
                }
            } finally {
                currentStep = 0;
                disableButtons(false);
                isProcessing = false; // è§£é”æ“ä½œ
            }
        }

        async function checkInput(selectedTone) {
            if (isProcessing) return; // é˜»æ­¢é‡å¤ç‚¹å‡»
            
            const expectedTone = currentSequence[currentStep].tone;
            
            if (selectedTone == expectedTone) {
                isProcessing = true; // é”å®šæ“ä½œ
                audioController.abort();
                audioController = new AbortController();
                
                // å…ˆæ›´æ–°æ­¥éª¤å†æ’­æ”¾éŸ³é¢‘
                currentStep++;
                const currentIndex = currentStep - 1;
                
                try {
                    await playSingleTone(currentIndex, audioController.signal);
                    
                    if (currentStep === currentSequence.length) {
                        showFeedback('pass.png', 'winSound');
                        if (currentLevel === 10) {
                            setTimeout(() => showResult(10), 1000);
                        } else {
                            setTimeout(nextLevel, 1000);
                        }
                    }
                } finally {
                    isProcessing = false; // è§£é”æ“ä½œ
                }
            } else {
                isProcessing = true; // é”å®šæ“ä½œ
                audioController.abort();
                showFeedback('sad.png', 'failSound');
                const btn = document.querySelector(`[data-tone="${selectedTone}"]`);
                btn.classList.add('wrong');
                setTimeout(() => btn.classList.remove('wrong'), 300);
                
                mistakes++;
                updateHearts();
                
                if (mistakes >= maxMistakes) {
                    setTimeout(() => showResult(currentLevel - 1), 1000);
                } else {
                    disableButtons(true);
                    setTimeout(async () => {
                        await playQuestionPhase();
                        disableButtons(false);
                    }, 1000);
                }
                isProcessing = false; // è§£é”æ“ä½œ
            }
        }

        // å…¶ä»–ä¿æŒä¸å˜çš„å‡½æ•°
        function updateHearts() {
            const hearts = Array.from(document.querySelectorAll('.heart')).reverse();
            hearts.forEach((heart, index) => {
                heart.classList.toggle('lost', index < mistakes);
            });
        }

        function showFeedback(imageSrc, soundId) {
            const feedback = document.createElement('img');
            feedback.src = imageSrc;
            feedback.className = 'feedback-image';
            document.body.appendChild(feedback);
            
            const sound = document.getElementById(soundId);
            sound.currentTime = 0;
            sound.play();

            setTimeout(() => {
                feedback.remove();
            }, 2000);
        }

        function generateSequence(length) {
            return Array.from({length}, () => tones[Math.floor(Math.random()*4)]);
        }

        function nextLevel() {
            currentSequence = generateSequence(currentLevel);
            document.getElementById('levelStatus').textContent = `Nivel ${currentLevel} - ${currentLevel} sÃ­laba${currentLevel > 1 ? 's' : ''}`;
            document.getElementById('progressBar').style.width = `${(currentLevel/10)*100}%`;
            playQuestionPhase();
            currentLevel++;
        }

        function disableButtons(state) {
            document.querySelectorAll('.tone-btn').forEach(btn => {
                btn.disabled = state;
                btn.onclick = state ? null : () => checkInput(btn.dataset.tone);
            });
        }

        function restartGame() {
            document.getElementById('resultModal').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameContainer').style.display = 'none';
            currentLevel = 1;
            mistakes = 0;
            updateHearts();
        }

        function shareResult() {
            const resultText = `${document.getElementById('resultTitle').textContent}\n${document.getElementById('resultMessage').textContent}`;
            if (navigator.share) {
              navigator.share({
                  title: 'ğŸ‰ æˆ‘çš„æ±‰è¯­å£°è°ƒæŒ‘æˆ˜æˆç»©',
                  text: resultText,
                  url: 'https://nas.io/baimu'
                })
              .then(() => console.log('åˆ†äº«æˆåŠŸ'))
              .catch((error) => console.log('åˆ†äº«å–æ¶ˆ', error));
            } else {
                navigator.clipboard.writeText(`${resultText}\n\nç«‹å³æŒ‘æˆ˜ â†’ https://nas.io/baimu`)
                    .then(() => alert('ğŸ“‹ ç»“æœå·²å¤åˆ¶ï¼Œå¿«å»ç²˜è´´åˆ†äº«å§ï¼'))
                    .catch(() => alert('âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬'));
            }
            
        function showResult(passedLevels) {
            const messages = [
                { level: 10, msg: "Â¡Dios mÃ­o, eres un prodigio del chino! ğŸŒ Tu talento supera al 99% del mundo. Â¡No desperdicies este don, empieza ya nuestro curso GRATIS!" },
                { level: 9, msg: "Â¡Casi perfecto! ğŸŒŸ Tu talento supera al 95% del mundo. Â¿Listo para ser fluido? Â¡Nuestro curso te llevarÃ¡ al mÃ¡ximo!" },
                { level: 8, msg: "Â¡Impresionante! ğŸ”¥ Superas al 80%. Solo un paso mÃ¡s para la maestrÃ­a. Â¡Aprovecha nuestras lecciones gratuitas!" },
                { level: 7, msg: "Â¡Muy bien! ğŸš€ Tu chino supera al 65%. Con un poco de estudio, Â¡serÃ¡s increÃ­ble! Â¿Empezamos hoy?" },
                { level: 6, msg: "Â¡Buen progreso! ğŸŒ± Superas al 50%. Â¿Quieres destacar? Â¡Nuestro curso te da las herramientas!" },
                { level: 5, msg: "Â¡Tienes potencial! ğŸ’¡ Superas al 40%. Con nuestras clases, Â¡transformarÃ¡s 'hola' en conversaciones!" },
                { level: 4, msg: "Â¡Sigue asÃ­! ğŸŒˆ Tu chino supera al 30%. Â¿SabÃ­as que en 10 lecciones podrÃ­as triplicarlo? Â¡Prueba gratis!" },
                { level: 2, msg: "Â¿Primer contacto? ğŸ˜… Superas al 20%. Â¡Aprende pinyin con nosotros y verÃ¡s la magia! âœ¨" },
                { level: 0, msg: "Â¿Se te resbalÃ³ el dedo? ğŸ˜œ Â¡IntÃ©ntalo de nuevo o mejorâ€¦ ven a descubrir el chino desde cero! ğŸ†“" }
            ];

            const result = messages.find(m => passedLevels >= m.level) || messages[messages.length-1];
            
            // æ’­æ”¾å¥–æ¯éŸ³æ•ˆ
            const trophySound = document.getElementById('trophySound');
            trophySound.currentTime = 0;
            trophySound.play();
            // æ§åˆ¶å›¾ç‰‡æ˜¾ç¤º
            const trophyImg = document.getElementById('trophyImage');
            if(passedLevels >= 1) {
                trophyImg.style.display = 'block';
            } else {
                trophyImg.style.display = 'none';
            }
            document.getElementById('resultTitle').textContent = `Â¡Completaste ${passedLevels} niveles!`;
            document.getElementById('resultMessage').textContent = result.msg;
            document.getElementById('resultModal').style.display = 'block';
            document.getElementById('gameContainer').style.display = 'none';
        }
            
        function startGame() {
            console.log('å‡½æ•°å·²è§¦å‘');
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            mistakes = 0;
            updateHearts();
            nextLevel();
        }
    </script>
<div id="shareFallback">ğŸ“‹ é“¾æ¥å·²å¤åˆ¶ï¼Œå¿«å»ç²˜è´´åˆ†äº«å§ï¼</div>
</body>
</html>
